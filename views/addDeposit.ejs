<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="/images/favicon.png">
  <title>Add Deposit</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      background-color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .navbar-brand { font-weight: 600; }

    .card {
      border-radius: 14px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.06);
      border: none;
    }

    .btn-sm { padding-inline: 0.6rem; }

    .btn-primary {
      background-color: #FF4E00;
      border-color: #FF4E00;
      transition: all .2s ease;
    }

    .btn-primary:hover {
      background-color: #ff7a33;
      border-color: #ff7a33;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(255, 78, 0, 0.25);
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-light bg-white shadow-sm border-bottom">
    <div class="container d-flex justify-content-between">
      <a href="/" class="navbar-brand">CampusLytics</a>

      <div class="d-flex gap-2">
        <form action="/" method="get">
          <button class="btn btn-outline-primary btn-sm" type="submit">Home</button>
        </form>
        <form action="/logout" method="get">
          <button class="btn btn-outline-secondary btn-sm" type="submit">Logout</button>
        </form>
      </div>
    </div>
  </nav>

  <!-- MAIN CONTENT -->
  <div class="container mt-5">
    <div class="col-12 col-md-7 col-lg-6 mx-auto">
      <div class="card form-card p-4">

        <h2 class="mb-3 text-center">Add Deposit</h2>
        <p class="text-muted text-center mb-4">
          Enter the details for this deposit and starting balance for the period.
        </p>

        <% if (typeof error_message !== 'undefined' && error_message) { %>
          <div class="alert alert-danger">
            <%= error_message %>
          </div>
        <% } %>

        <form action="/addDeposit" method="post" class="row g-3">

          <div class="col-md-6">
            <label for="depositDate" class="form-label">Deposit Date</label>
            <input
              type="date"
              class="form-control"
              id="depositDate"
              name="depositDate"
              required
            >
          </div>

          <div class="col-md-6">
            <label for="depositAmount" class="form-label">Deposit Amount ($)</label>
            <input
              type="number"
              class="form-control"
              id="depositAmount"
              name="depositAmount"
              step="0.01"
              min="0"
              required
            >
          </div>

          <div class="col-md-6">
            <label for="hoursWorked" class="form-label">Hours Worked (optional)</label>
            <input
              type="number"
              class="form-control"
              id="hoursWorked"
              name="hoursWorked"
              step="0.01"
              min="0"
            >
          </div>

          <div class="col-md-6">
            <label for="startBalance" class="form-label">Start Balance</label>
            <input
              type="number"
              class="form-control"
              id="startBalance"
              name="startBalance"
              step="0.01"
              min="0"
            >
            <div class="form-text">Or check “Use previous end balance”.</div>

            <!-- Server should trust these: -->
            <input type="hidden" id="startBalanceMode" name="startBalanceMode" value="manual">
            <input type="hidden" id="startBalanceValue" name="startBalanceValue" value="">

            <!-- checkbox stays under Start Balance -->
            <div class="form-check mt-2">
              <input
                class="form-check-input"
                type="checkbox"
                id="usePreviousEndBalance"
                name="usePreviousEndBalance"
              />
              <label class="form-check-label small text-muted" for="usePreviousEndBalance">
                Use previous end balance
              </label>
            </div>

            <!-- dropdown stays under Start Balance -->
            <div class="mt-2 d-none" id="previousDepositContainer">
              <label for="previousDepositId" class="form-label">Choose previous deposit</label>
              <select class="form-select" id="previousDepositId" name="previousDepositId">
                <option value="">Select a deposit…</option>

                <% if (Array.isArray(deposits)) { %>
                  <% deposits.forEach(d => { %>
                    <option
                      value="<%= d.depositID %>"
                      data-end-balance="<%= d.endBalance %>"
                    >
                      <%= new Date(d.depositDate).toLocaleDateString('en-US') %>
                      — $<%= Number(d.endBalance).toFixed(2) %>
                    </option>
                  <% }) %>
                <% } %>
              </select>

              <div class="form-text">
                We’ll use that deposit’s ending balance as this period’s start balance.
              </div>
            </div>
          </div>

          <div class="col-md-12">
            <label for="notes" class="form-label">Notes (optional)</label>
            <textarea
              id="notes"
              name="notes"
              class="form-control"
              rows="2"
            ></textarea>
          </div>

          <div class="col-12 text-center">
            <button type="submit" class="btn btn-primary w-100 mt-3">
              Save Deposit
            </button>
          </div>

        </form>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const checkbox = document.getElementById('usePreviousEndBalance');
      const startBalanceInput = document.getElementById('startBalance');
      const modeInput = document.getElementById('startBalanceMode');
      const startBalanceValue = document.getElementById('startBalanceValue');

      const previousContainer = document.getElementById('previousDepositContainer');
      const previousSelect = document.getElementById('previousDepositId');

      if (!checkbox || !startBalanceInput || !modeInput || !previousContainer || !previousSelect || !startBalanceValue) {
        console.log('Missing elements:', {
          checkbox, startBalanceInput, modeInput, previousContainer, previousSelect, startBalanceValue
        });
        return;
      }

      function applySelectedEndBalance() {
        const opt = previousSelect.options[previousSelect.selectedIndex];
        const raw = opt ? opt.getAttribute('data-end-balance') : '';

        if (!raw) {
          startBalanceValue.value = '';
          startBalanceInput.value = '';
          return;
        }

        const n = Number(raw);
        if (!Number.isFinite(n)) {
          startBalanceValue.value = '';
          startBalanceInput.value = '';
          return;
        }

        const formatted = n.toFixed(2);
        startBalanceValue.value = formatted;  // what the server should use
        startBalanceInput.value = formatted;  // display to user (even though disabled)
      }

      function setUsePrevious(isChecked) {
        if (isChecked) {
          // disable + grey out start balance input
          startBalanceInput.disabled = true;
          startBalanceInput.classList.add('bg-light');
          startBalanceInput.value = '';

          // show dropdown + require it
          previousContainer.classList.remove('d-none');
          previousSelect.required = true;

          // tell server to treat as default
          modeInput.value = 'default';

          applySelectedEndBalance();
        } else {
          // enable start balance
          startBalanceInput.disabled = false;
          startBalanceInput.classList.remove('bg-light');

          // hide dropdown + un-require it
          previousContainer.classList.add('d-none');
          previousSelect.required = false;
          previousSelect.value = '';

          // tell server it's manual
          modeInput.value = 'manual';

          // hidden value should reflect what user typed
          startBalanceValue.value = startBalanceInput.value;
        }
      }

      // keep hidden value synced for manual entry
      startBalanceInput.addEventListener('input', () => {
        if (modeInput.value === 'manual') {
          startBalanceValue.value = startBalanceInput.value;
        }
      });

      // update start balance when dropdown changes
      previousSelect.addEventListener('change', () => {
        if (modeInput.value === 'default') {
          applySelectedEndBalance();
        }
      });

      // initialize state (handles refresh/back button)
      setUsePrevious(checkbox.checked);

      checkbox.addEventListener('change', () => {
        setUsePrevious(checkbox.checked);
      });
    });
  </script>

</body>
</html>
